---
title: "Midterm"
author: "Sri Seshadri"
date: "4/15/2018"
output: 
pdf_document:
  toc: true
  toc_depth : 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(dplyr)
library(forecast)
library(zoo)
library(ggplot2)
library(stringr)
```


# Objective

Predict total sales for every product and store in the next month for the data provided by 1C Company.

# Data

Data was obtained from "https://www.kaggle.com/c/competitive-data-science-predict-future-sales/data". The data is in Russian language and a translated version of the data was obtained from discussion forum in Kaggle. Attribute such as the store location was also obtained from the discussion forum.


# Exploratory Data Analysis

```{r}
# Training data set
sales_train <- read.csv("./Midterm/sales_train_v2.csv", header = T, stringsAsFactors = F)
# Item categories
ItemCategories <- read.csv("./Midterm/item_categories.csv")
# Items
Items <- read.csv('./Midterm/items.csv')

# Items look up translated

ItemsReference <- readxl::read_xlsx(path = "./Midterm/LookUps.xlsx", sheet = "items-translated")
test <- readxl::read_xlsx(path = "./Midterm/LookUps.xlsx", sheet = "test")
ShopReference <- readxl::read_xlsx(path = "./Midterm/LookUps.xlsx", sheet = "ShopLocations")
ShopReference %<>% dplyr::mutate(city = as.factor(city),shop_id = as.integer(shop_id)) %>% dplyr::select(-lat,-long)
ItemCatNomenclature <- readxl::read_xlsx(path = "./Midterm/LookUps.xlsx", sheet = "item_categories-translated.csv")
ItemsReference %<>% dplyr::mutate(item_id = as.integer(item_id),
                                  Cinema = ifelse(stringr::str_detect(Category,"Cinema"),1,0),
                                  Music = ifelse(stringr::str_detect(Category,"Music"),1,0),
                                  Games = ifelse(stringr::str_detect(Category,"Games"),1,0),
                                  Books = ifelse(stringr::str_detect(Category,"Books"),1,0),
                                  Accesories = ifelse(stringr::str_detect(Category,"Accessories"),1,0),
                                  Gifts = ifelse(stringr::str_detect(Category,"Gifts"),1,0),
                                  Programs = ifelse(stringr::str_detect(Category,"Programs"),1,0) # needing to find how two keyword in a category need to be adjusted?
                                  ) %>% 
  dplyr::mutate(Others = ifelse(rowSums(.[5:11]) < 1,1,0)) %>% 
  dplyr::mutate_at(.vars = 5:12, funs(factor))

#--------------------------------------------------------------------------------------------------
#                               Aggregated data
#-------------------------------------------------------------------------------------------------- 
Agg_sales_train <- sales_train %>% 
                 dplyr::mutate(date = lubridate::parse_date_time(date,orders = "%d.%m.%Y"),
                               month = lubridate::month(date),
                               year = lubridate::year(date),
                               YearMonth = (year + month/100),
                               shop_id = as.integer(shop_id),
                               item_id = as.integer(item_id)) %>% 
                 dplyr::group_by(item_id,shop_id,date_block_num,YearMonth) %>% 
                 dplyr::summarise(MonthlyCts = sum(item_cnt_day),Price = mean(item_price,na.rm = T)) %>% 
                 dplyr::arrange(item_id,shop_id,date_block_num) %>% 
                 dplyr::mutate(Item.Shop = item_id + shop_id / 100) %>% 
                 dplyr::left_join(x = ., y = Items[,2:3]) %>% 
                 dplyr::left_join(x =., y = ItemsReference[,c(1,5:12)]) %>% 
                 dplyr::left_join(x =., y = ShopReference[,2:5])

#-------------------------------------------------------------------
# Reference frame
#-------------------------------------------------------------------
# lookup for date_block_num for ts() at a later time
dateblockref <-
  Agg_sales_train %>% dplyr::ungroup() %>% 
  dplyr::distinct(date_block_num, YearMonth) %>% 
  arrange(date_block_num) %>% 
  tidyr::separate(YearMonth,c("year","month")) %>% 
  dplyr::mutate_at(.vars = c("year","month"),funs(as.integer))
df <-
  data.frame(
  date_block_num = rep(seq(
  min(Agg_sales_train$date_block_num),
  max(Agg_sales_train$date_block_num)
  ), n_distinct(Agg_sales_train$Item.Shop)),
  Item.Shop = rep(
  unique(Agg_sales_train$Item.Shop),
  each = max(Agg_sales_train$date_block_num) - min(Agg_sales_train$date_block_num) + 1
  )
  ) %>%
  #tidyr::separate(., 2, c("item_id", "shop_id",sep = "\\.")) %>%
  #dplyr::mutate(shop_id = ifelse(is.na(shop_id), 0, shop_id)) %>%
  #dplyr::mutate(item_id = as.integer(item_id), shop_id = as.integer(shop_id)) %>% 
  dplyr::mutate(item_id = as.integer(floor(Item.Shop)), shop_id = as.integer((Item.Shop - item_id)*100)) %>% 
  dplyr::left_join(.,dateblockref)


#---------------------------------------------------------------------------------------
# Monthly sales reference data frame  - Master data framw
#---------------------------------------------------------------------------------------
MonthlySales.ItemShop <- df[,-2] %>% 
        dplyr::left_join(.,Agg_sales_train[,c(1:6)],by = c("item_id" = "item_id", "shop_id" = "shop_id","date_block_num" = "date_block_num")) %>% 
        dplyr::left_join(.,ItemsReference[-2]) %>% 
        dplyr::left_join(.,ShopReference[2:3]) %>% 
        dplyr::mutate(city = as.factor(city)) %>% 
        dplyr::select(-YearMonth) %>% # redundant
        dplyr::mutate(imp = ifelse(is.na(MonthlyCts),1,0)) %>% # id rows imputed
        dplyr::mutate(MonthlyCts = ifelse(imp==1,0,MonthlyCts)) %>% 
        dplyr::arrange(item_id,shop_id,date_block_num) %>%
        dplyr::distinct() # Spent 10 hours trying to digure what is causing the duplicates... no success.
#dplyr::mutate(Cusum = ave(x = MonthlyCts,item_id, FUN = cumsum)) # Is used to identify the begining of the timeseries

# ------------------------------------------------------------------------------------------
# DO I NEED THIS NOW???
#--------------------------------------------------------------------------------------------
MonthlySales.Train <- MonthlySales.ItemShop %>% 
        dplyr::mutate(ItemShop = item_id + shop_id/100) %>% 
        dplyr::select(date_block_num,ItemShop,MonthlyCts, Price,city) %>% 
        #dplyr::mutate(MonthlyCts = ifelse(is.na(MonthlyCts),0,MonthlyCts)) %>% 
        dplyr::group_by(ItemShop,date_block_num) %>% 
        dplyr::summarise(Sales = sum(MonthlyCts,na.rm = T)) %>% 
        tidyr::spread(ItemShop,Sales)


# There are several variables that have very little data , what are they
NearZeroVars <- caret::nearZeroVar(MonthlySales.Train, names = F)
MonthlySalests <- as.ts(MonthlySales.Train[,c(1,NearZeroVars)*-1],frequency = 1, start = 0, end = 33)


# Summay by Item Category
MonthlySalebyCategory  <- MonthlySales.ItemShop %>% dplyr::group_by(date_block_num,item_category_id) %>% 
  dplyr::summarise(SaleCounts = sum(MonthlyCts,na.rm = T)) %>% 
  tidyr::spread(item_category_id, SaleCounts)

colnames(MonthlySalebyCategory) <- c("date_block_num",stringi::stri_replace_all_fixed(ItemCatNomenclature$item_category_name_translated," ",""))
# How are categories related?

## remove categories that have zero variance
ZeroVars <- caret::nearZeroVar(MonthlySalebyCategory)
cormat <- cor(MonthlySalebyCategory[c(1,ZeroVars)*-1])


#-----------------------------------------------------------------------------------------------
# Utility functions
#-------------------------------------------------------------------------------------------------

# 1. INput Category, get items and store ids
RetrieveItemStores <- function(data = MonthlySales.ItemShop, category) {
  data %>% 
    filter(item_category_id %in% category) %>%
    #dplyr::distinct(item_id,shop_id,item_category_id) %>% 
    dplyr::group_by(item_id,shop_id,item_category_id) %>% 
    dplyr::summarise(Datapoints = sum(!is.na(MonthlyCts))/nrow(.)) %>% 
    #dplyr::distinct(item_id,shop_id,keep.all = T) %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(Item.Shop = item_id + shop_id/100) %>% 
    dplyr::select(Item.Shop,item_category_id,Datapoints) %>% 
    dplyr::filter(Item.Shop %in% as.numeric(colnames(!!MonthlySales.Train)[NearZeroVars*-1])) %>% 
    dplyr::arrange(item_category_id,desc(Datapoints)) %>% 
    dplyr::mutate(item_id = as.integer(floor(Item.Shop)), shop_id = as.integer((Item.Shop - item_id)*100))
}


# 2, Category KJ

SuperCategory <- function(string) {
  supercatlist <- c("Cinema", "Music", "Game", "Books", "Accessories", "Gifts", "Program","Payments")
  position = str_which(string = string,pattern = supercatlist)
  if (length(position) == 1) {
     supercatlist[position]
  } else 
    if(length(position) > 1){
      if(str_detect(string,"Payment")){
        "Payments"
      } else "Gifts"
    }
  else "Others"
    
}


# 3 ArrangeData

ArrangeData <- function(data = MonthlySales.ItemShop, CategorySuperlative = NULL, 
                        item_category_id = NULL, CategoryDesc = NULL,store_ids = NULL, 
                        item_ids = NULL,response = NULL, aggCriteria = NULL, ...){
  opts <- list(...) # How can we use High level Category filters?
   browser()
  # Get Item.Shops for aggregation
  if(!is.null(aggCriteria)){
     
    stopifnot(!is.null(response))
    criteria <- names(aggCriteria)
    if(is.element("item_ids",criteria)){
      aggItemIDs <- aggCriteria$item_ids
    } else{
       aggItemIDs <- NULL
    }
    
    if(is.element("CategorySuper", criteria)) {
      # using lexical scoping here
      aggItemIDs <- c(aggItemIDs,
                      ItemsReference %>% dplyr::select(item_id,!!aggCriteria$CatergorySuper) %>%
        dplyr::filter_at(2,any_vars(as.integer(.)== 2)) %>% dplyr::select(item_id) %>% .$item_id)

     
      }
    if(is.element("category_id", criteria)){
      aggItemIDs <- c(aggItemIDs,
                      ItemsReference %>% dplyr::select(item_id,item_category_id) %>% 
                        dplyr::filter(item_category_id %in% !!aggCriteria$category_id) %>% 
                        .$item_id)
    }
    if(is.element("shop_ids",criteria)){
      aggShopIDs <- aggCriteria$shop_id
    } else aggShopIDs <- NULL
    
    if(is.element("location",criteria)) {
      locFlag = T
    } else locFlag = F
  }
  
  # filter by super category
  if(!is.null(CategorySuperlative)){
   data %<>% dplyr::filter_at(vars(which(colnames(.) %in% CategorySuperlative)),any_vars(as.integer(.)== 2))
  }

  # filter by item_category_id
  if(!is.null(item_category_id)){
    data %<>% dplyr::filter(item_category_id %in% !!item_category_id)
  }
  if(!is.null(CategoryDesc)){
    data %<>% dplyr::filter(Category %in% !!CategoryDesc)
  }
  if(!is.null(item_ids)) {
    data %<>% dplyr::filter(item_id %in% !!item_ids)
  }
  if(!is.null(store_ids)){
    data %<>% dplyr::filter(store_id %in% !!store_ids)
  }
  
  # Aggregation
  
if(!is.null(aggCriteria)){
  ResponseCriteria = names(response)
  if(all(is.element(c("shop_id","item_id"),ResponseCriteria))){
    Response <- data  %>% 
      dplyr::filter(item_id == !!response$item_id, shop_id == !!response$shop_id) %>% 
      dplyr::select(date_block_num,item_id,shop_id,MonthlyCts,Price) %>% 
      dplyr::arrange(date_block_num,item_id,shop_id) %>% 
      dplyr::mutate(Item.Shop = as.character(item_id + shop_id/100))
  } else{
    if(all(is.element(c("shop_id","item_category_id"),ResponseCriteria))){
      Response <- data  %>% 
        dplyr::filter(item_category_id == !!response$item_category_id, shop_id == !!response$shop_id) %>% 
        dplyr::select(date_block_num,shop_id,item_category_id,MonthlyCts,Price) %>% 
        dplyr::arrange(date_block_num,item_category_id,shop_id) %>% 
        dplyr::group_by(date_block_num,item_category_id,shop_id) %>% 
        dplyr::summarise(MonthlyCts = sum(MonthlyCts, na.rm = T), Price = mean(Price,na.rm = T)) %>% 
        dplyr::mutate(itmCatid.ShopID = as.character(item_category_id + shop_id/100))
    }
    else{
      if(all(is.element(c("shop_id","CategorySuper"),ResponseCriteria))){
        
        aggResItemIDs <-  ItemsReference %>% dplyr::select(item_id,!!ResponseCriteria$CatergorySuper) %>%
          dplyr::filter_at(2,any_vars(as.integer(.)== 2)) %>% dplyr::select(item_id) %>% .$item_id
        
        Response <- data  %>% 
          dplyr::filter(item_id == !!aggResItemIDs, shop_id == !!response$shop_id) %>% 
          dplyr::select(date_block_num,item_id,shop_id,MonthlyCts,Price) %>% 
          dplyr::arrange(date_block_num,item_id,shop_id) %>% 
          dplyr::group_by(date_block_num,item_id,shop_id) %>% 
          dplyr::summarise(MonthlyCts = sum(MonthlyCts, na.rm = T), Price = mean(Price,na.rm = T)) %>% 
          dplyr::mutate(Item.ShopID = as.character(item_id + shop_id/100))
      }
    }
  }
  
  responseitemids <- Response %>% dplyr::ungroup() %>% distinct(item_id) %>% .$item_id
  responseshopids <- Response %>% dplyr::ungroup() %>% distinct(shop_id) %>% .$shop_id
  
  Predictors.ItemIDs <- setdiff(aggItemIDs,responseitemids)
  Predictors.ShopIDs <- setdiff(aggShopIDs,responseshopids)
  
  Predictors <- data %>% 
    dplyr::filter(shop_id %in% !!Predictors.ShopIDs,
                  item_id %in% !!Predictors.ItemIDs) %>% 
    dplyr::arrange(date_block_num,item_id,shop_id)
  
  if(locFlag){
    if(nrow(Predictors) > 0){
      Predictors %<>% dplyr::group_by(date_block_num,item_id,city) %>% 
      dplyr::summarise(MonthlyCts = sum(MonthlyCts,na.rm = T),Price = mean(Price,na.rm = T)) %>% 
      dplyr::mutate(Item.City = paste0(as.character("item_id"),"_",city))
    } else {
      Predictors <- data %>% dplyr::group_by(date_block_num,item_id,city) %>% 
      dplyr::summarise(MonthlyCts = sum(MonthlyCts,na.rm = T),Price = mean(Price,na.rm = T)) %>% 
      dplyr::mutate(Item.City = paste0(as.character("item_id"),"_",city))
    }
    
    
  } else{
    Predictors %<>% dplyr::group_by(date_block_num,item_id,shop_id) %>% 
      dplyr::summarise(MonthlyCts = sum(MonthlyCts,na.rm = T),Price = mean(Price,na.rm = T)) %>% 
      dplyr::mutate(Item.Shop = as.character(item_id + shop_id/100))
  }
  
  browser()
    
} else {
  # selection
  data %<>% dplyr::mutate(Item.Shop = as.character(item_id + shop_id/100)) %>% 
    dplyr::select(date_block_num,Item.Shop,MonthlyCts,Price)
  
  # spread 
  
  data %<>%

    tidyr::gather(variable,value, -c(date_block_num,Item.Shop)) %>%
    tidyr::unite(temp,Item.Shop,variable) %>%
    tidyr::spread(temp,value)
}
  
  
  # 
  # 
  # ts(data,start = 2013, frequency = 12)
  # 
}


```

## Data exploration by item category

In this section we'll explore the correlation amongst item categories. 

```{r,fig.width=4}
# Correlation plot 
corrplot::corrplot(cormat,order = "hclust",tl.cex = 0.3)
library(reshape2)
HighCors <- subset(melt(cormat,varnames = c('CatA', 'CatB'), value.name = 'Correlations'), Correlations >= 0.8 & Correlations < 1)

HighCors[which(HighCors$CatA == 40),] %>% distinct(CatB)
testdf <- RetrieveItemStores(category = 2) %>% distinct(item_id)
# Roll up category further
MonthlySalebyCategoryGrp <-
  MonthlySales.ItemShop %>% dplyr::group_by(date_block_num, item_category_id) %>%
  dplyr::summarise(SaleCounts = sum(MonthlyCts, na.rm = T)) %>% 
  dplyr::left_join(.,ItemCatNomenclature) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(SuperCategory = unlist(purrr::map(item_category_name_translated, SuperCategory)))

MonthlySalebyCategoryGrp %<>% 
  dplyr::group_by(date_block_num,SuperCategory) %>% 
  dplyr::summarise(Sales = sum(SaleCounts)) %>% 
  tidyr::spread(SuperCategory,Sales)

cormat2 <- cor(MonthlySalebyCategoryGrp[-1])
corrplot::corrplot(cormat2,method = c("number"))

HighCors2 <- subset(melt(cormat2,varnames = c('CatA', 'CatB'), value.name = 'Correlations'), Correlations >= 0.8 & Correlations < 1)

```

## Gaming consoles, accessories and games.

```{r}
MonthlySalebyCategory %>% 
  dplyr::ungroup() %>% 
  dplyr::select(`Games-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `Games-PS3`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw()

MonthlySalebyCategory %>% 
  dplyr::ungroup() %>% 
  dplyr::select(`GameConsoles-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `GameConsoles-PS3`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("Accesories PS3") + theme_bw()

MonthlySalebyCategory %>% 
  dplyr::ungroup() %>% 
  dplyr::select(`GameConsoles-PS3`,`GameConsoles-PSVita`) %>% ggplot(mapping = aes(x = `GameConsoles-PSVita`, y = `GameConsoles-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("PS Vita") + theme_bw()


```

### Do the linear relationship hold true across shops

The 

```{r}
# Data set up

Categoriesofinterest <- c(2,5,11,19,32,37:40,55:60,62)


Agg_Sales_Category <- Agg_sales_train %>% dplyr::ungroup() %>% 
  dplyr::mutate(shop_id = as.factor(shop_id)) %>% 
  dplyr::filter(item_category_id %in% !!Categoriesofinterest) %>%
  dplyr::group_by(shop_id,item_category_id,date_block_num) %>% 
  dplyr::summarise(Sale = sum(MonthlyCts,na.rm = T)) %>% 
  tidyr::spread(item_category_id,Sale) 

Agg_Price_Category <- Agg_sales_train %>% 
   dplyr::ungroup() %>% 
  dplyr::mutate(shop_id = as.factor(shop_id)) %>% 
  dplyr::filter(item_category_id %in% !!Categoriesofinterest) %>%
  dplyr::group_by(shop_id,item_category_id,date_block_num) %>% 
  dplyr::summarise(Price = mean(Price,na.rm = T)) %>% 
  tidyr::spread(item_category_id,Price)

colnames(Agg_Price_Category)[3:(2+length(Categoriesofinterest))] <- paste0("Price",Categoriesofinterest)
Agg_Sales_Category %<>% dplyr::left_join(.,Agg_Price_Category)
# Plotting 
Agg_Sales_Category %>% ggplot(mapping = aes(x = `19`, y = `2`,col = shop_id)) + geom_point() + stat_smooth(method = "lm",se = F) + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw() + theme(legend.position = "none") + ggtitle( "PS3 Game sales Vs PS3 Accessories", subtitle = "Colored by shop_id")
  
```

# Linear model for PS3 Accesories sale

```{r}
fit.PS3Acc <- lm(`2` ~  `19` + `62` +  Price19 + Price2 + Price62 + shop_id, data = Agg_Sales_Category)
summary(fit.PS3Acc)
broom::augment(fit.PS3Acc) %>% lattice::xyplot(.fitted ~ X2, data = .,xlab = "Accesories PS3 sales", ylab = "Fitted PS3 Accesories sale")

```

## Top Down approach from here?

```{r}
Agg_Sales_Category %>% ggplot(mapping = aes(x = `37`, y = `55`,col = shop_id)) + geom_point() + stat_smooth(method = "lm",se = F) + xlab("Cinema Blue Ray") + ylab("Music CD Local") + theme_bw() + theme(legend.position = "none") + ggtitle( "Cinema Blue Ray Vs Music CD local sales", subtitle = "Colored by shop_id")


```


```{r}
fit <- lm(`55` ~  `37`  +  Price55 + Price37 + shop_id , data = Agg_Sales_Category,subset = Agg_Sales_Category$shop_id %in% c(28,31,53,54))
summary(fit)
broom::augment(fit) %>% lattice::xyplot(.fitted ~ X55, data = .,xlab = "Cinema Blue Ray Sales", ylab = "Fitted Blue Ray sales")

```

# Do the relationships generalize to each item_id?

```{r}
MusicCDtrain <- Agg_sales_train %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(item__id = as.factor(item_id),shop_id = as.factor(shop_id),Item.Shop = as.factor(Item.Shop)) %>%
  dplyr::mutate(item_category_id = as.factor(item_category_id)) %>% 
  dplyr::filter(item_category_id %in% c(55,37)) %>% 
  dplyr::select(Item.Shop,MonthlyCts,date_block_num) %>% 
  tidyr::spread(Item.Shop,MonthlyCts)
items_id_37 <- RetrieveItemStores(category = 37) %>% distinct(item_id)
items_id_55 <- RetrieveItemStores(category = 55) %>% distinct(item_id)
Predictors <- colnames(MusicCDtrain)[stringr::str_detect(colnames(MusicCDtrain), as.character(items_id_37$item_id))]
Reponses <- colnames(MusicCDtrain)[stringr::str_detect(colnames(MusicCDtrain), as.character(items_id_55$item_id))]


# MusicCDtrain %>% dplyr::filter(complete.cases(.))
# 
# paste0("`",paste0(Predictors,pad = '`'),collapse = "+")
# 
# lm(`1201.04` ~ `935.07`+`965`+`2137.35`+`2631.31`+`3620.31`+`4982.29`+`5331.39`+`5331.42`+`6333.18`+`7265.41`+`7314.07`+`7430.26`+`7485.15`+`7499.45`+`7531.07`+`7651.35`+`8280.44`+`8297.34`+`8318.28`+`8683.31`+`8739.46`+`9165.41`+`9578.29`+`9597.31`+`10021.47`+`10300.48`+`10446.45`+`10876.19`+`11629.21`+`12455.31`+`12459.06`+`12718.57`+`12785.13`+`13785.57`+`13855.57`+`14143.24`+`14271.21`+`14282.22`+`14387.42`+`14522.28`+`14672.33`+`15558.43`+`15702.29`+`16677.29`+`16710.44`+`16725.35`+`16874.26`+`16889.52`+`17174.28`+`17499.57`+`17833.13`+`18259.46`+`18537.13`+`18589.5`+`18592.57`+`18881.38`+`19162.48`+`19185.54`+`19195.35`+`19287.07`+`19547.51`+`21357.49`+`21426.42`+`21542.15`+`21647.5`,data = MusicCDtrain,singular.ok = T)

```

# Linear Regerssion Modeling 

```{r}


```



