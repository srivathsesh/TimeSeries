browser()
if (length(position) == 1) {
supercatlist[position]
} else
if(length(position) > 1){
if(str_detect(string,"Payments")){
"Payments"
}
}
else "Others"
}
SuperCategory(MonthlySalebyCategoryGrp$item_category_name_translated[33])
str_detect(string,"Payments")
SuperCategory <- function(string) {
supercatlist <- c("Cinema", "Music", "Games", "Books", "Accesories", "Gifts", "Program","Payments")
position = str_which(string = string,pattern = supercatlist)
browser()
if (length(position) == 1) {
supercatlist[position]
} else
if(length(position) > 1){
if(str_detect(string,"Payment")){
"Payments"
}
}
else "Others"
}
SuperCategory(MonthlySalebyCategoryGrp$item_category_name_translated[33])
SuperCategory <- function(string) {
supercatlist <- c("Cinema", "Music", "Games", "Books", "Accesories", "Gifts", "Program","Payments")
position = str_which(string = string,pattern = supercatlist)
if (length(position) == 1) {
supercatlist[position]
} else
if(length(position) > 1){
if(str_detect(string,"Payment")){
"Payments"
}
}
else "Others"
}
MonthlySalebyCategoryGrp$SuperCat <- unlist(purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory))
SuperCategory <- function(string) {
supercatlist <- c("Cinema", "Music", "Games", "Books", "Accesories", "Gifts", "Program","Payments")
position = str_which(string = string,pattern = supercatlist)
if (length(position) == 1) {
supercatlist[position]
} else
if(length(position) > 1){
if(str_detect(string,"Payment")){
"Payments"
}
}
else "Others"
}
purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory)
lengths(purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory))
MonthlySalebyCategoryGrp$item_category_name_translated[65]
unique(MonthlySalebyCategoryGrp$item_category_name_translated)
SuperCategory <- function(string) {
supercatlist <- c("Cinema", "Music", "Games", "Books", "Accesories", "Gifts", "Program","Payments")
position = str_which(string = string,pattern = supercatlist)
if (length(position) == 1) {
supercatlist[position]
} else
if(length(position) > 1){
if(str_detect(string,"Payment")){
"Payments"
} else "Gifts"
}
else "Others"
}
MonthlySalebyCategoryGrp$SuperCat <- purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory)
View(MonthlySalebyCategoryGrp)
SuperCategory <- function(string) {
supercatlist <- c("Cinema", "Music", "Games", "Books", "Accessories", "Gifts", "Program","Payments")
position = str_which(string = string,pattern = supercatlist)
if (length(position) == 1) {
supercatlist[position]
} else
if(length(position) > 1){
if(str_detect(string,"Payment")){
"Payments"
} else "Gifts"
}
else "Others"
}
MonthlySalebyCategoryGrp$SuperCat <- purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory)
SuperCategory <- function(string) {
supercatlist <- c("Cinema", "Music", "Game", "Books", "Accessories", "Gifts", "Program","Payments")
position = str_which(string = string,pattern = supercatlist)
if (length(position) == 1) {
supercatlist[position]
} else
if(length(position) > 1){
if(str_detect(string,"Payment")){
"Payments"
} else "Gifts"
}
else "Others"
}
MonthlySalebyCategoryGrp$SuperCat <- purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory)
MonthlySalebyCategoryGrp <-
MonthlySales.ItemShop %>% dplyr::group_by(date_block_num, item_category_id) %>%
dplyr::summarise(SaleCounts = sum(MonthlyCts, na.rm = T)) %>%
dplyr::left_join(.,ItemCatNomenclature) %>%
dplyr::ungroup()
MonthlySalebyCategoryGrp <-
MonthlySales.ItemShop %>% dplyr::group_by(date_block_num, item_category_id) %>%
dplyr::summarise(SaleCounts = sum(MonthlyCts, na.rm = T)) %>%
dplyr::left_join(.,ItemCatNomenclature) %>%
dplyr::ungroup() %>%
dplyr::mutate(SuperCategory = purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory))
MonthlySalebyCategoryGrp %>% autoplot(date_block_num)
MonthlySalebyCategoryGrp %>% autoplot(~date_block_num)
MonthlySalebyCategoryGrp %>% lattice::xyplot(~date_block_num,data = .)
MonthlySalebyCategoryGrp %>% lattice::xyplot(date_block_num,data = .)
MonthlySalebyCategoryGrp %>% lattice::xyplot(~date_block_num,data = .)
MonthlySalebyCategoryGrp %>% lattice::xyplot.ts(~date_block_num,data = .)
plot(MonthlySalebyCategoryGrp$date_block_num)
MonthlySalebyCategoryGrp %>% dplyr::group_by(date_block_num,SuperCategory) %>% dplyr::summarise(Sales = sum(SaleCounts))
purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory)
unlist(purrr::map(MonthlySalebyCategoryGrp$item_category_name_translated, SuperCategory))
# Roll up category further
MonthlySalebyCategoryGrp <-
MonthlySales.ItemShop %>% dplyr::group_by(date_block_num, item_category_id) %>%
dplyr::summarise(SaleCounts = sum(MonthlyCts, na.rm = T)) %>%
dplyr::left_join(.,ItemCatNomenclature) %>%
dplyr::ungroup() %>%
dplyr::mutate(SuperCategory = unlist(purrr::map(item_category_name_translated, SuperCategory)))
MonthlySalebyCategoryGrp %>% dplyr::group_by(date_block_num,SuperCategory) %>% dplyr::summarise(Sales = sum(SaleCounts))
MonthlySalebyCategoryGrp %>% dplyr::group_by(date_block_num,SuperCategory) %>% dplyr::summarise(Sales = sum(SaleCounts)) %>% tidyr::spread(SuperCategory,Sales)
MonthlySalebyCategoryGrp %<>%
dplyr::group_by(date_block_num,SuperCategory) %>%
dplyr::summarise(Sales = sum(SaleCounts)) %>%
tidyr::spread(SuperCategory,Sales)
cormat2 <- cor(MonthlySalebyCategoryGrp[-1])
corrplot::corrplot(cormat2)
corrplot::corrplot(cormat2,method = "ellipse")
corrplot::corrplot(cormat2,method = c("ellipse","number"))
corrplot::corrplot(cormat2,method = c("number"))
# Correlation plot
corrplot::corrplot(cormat,order = "hclust",tl.cex = 0.3)
library(reshape2)
HighCors <- subset(melt(cormat,varnames = c('CatA', 'CatB'), value.name = 'Correlations'), Correlations >= 0.8 & Correlations < 1)
HighCors[which(HighCors$CatA == 40),] %>% distinct(CatB)
testdf <- RetrieveItemStores(category = 2) %>% distinct(item_id)
# Roll up category further
MonthlySalebyCategoryGrp <-
MonthlySales.ItemShop %>% dplyr::group_by(date_block_num, item_category_id) %>%
dplyr::summarise(SaleCounts = sum(MonthlyCts, na.rm = T)) %>%
dplyr::left_join(.,ItemCatNomenclature) %>%
dplyr::ungroup() %>%
dplyr::mutate(SuperCategory = unlist(purrr::map(item_category_name_translated, SuperCategory)))
MonthlySalebyCategoryGrp %<>%
dplyr::group_by(date_block_num,SuperCategory) %>%
dplyr::summarise(Sales = sum(SaleCounts)) %>%
tidyr::spread(SuperCategory,Sales)
cormat2 <- cor(MonthlySalebyCategoryGrp[-1])
corrplot::corrplot(cormat2,method = c("number"))
MonthlySalebyCategory
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`2`,`19`) %>% ggplot(mapping = aes(x = `19`, y = `2`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(3,20) %>% ggplot(mapping = aes(x = .[,2], y = .[,1])) + geom_point() + stat_smooth(method = "lm") + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(Games-PS3,Accessories-PS3) %>% ggplot(mapping = aes(x = Games-PS3, y = Accessories-PS3)) + geom_point() + stat_smooth(method = "lm") + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`Games-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `Games-PS3`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`GameConsoles-PS`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `GameConsoles-PS`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`GameConsoles-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `GameConsoles-PS`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`GameConsoles-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `GameConsoles-PS3`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`Games-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `Games-PS3`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`GameConsoles-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `GameConsoles-PS3`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`GameConsoles-PS3`,`GameConsoles-PSVita`) %>% ggplot(mapping = aes(x = `GameConsoles-PSVita`, y = `GameConsoles-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("PS Vita") + theme_bw()
HighCors
# Data set up
Categoriesofinterest <- c(2,5,11,19,32,37:40,55:60,62)
Agg_Sales_Category <- Agg_sales_train %>% dplyr::ungroup() %>%
dplyr::mutate(shop_id = as.factor(shop_id)) %>%
dplyr::filter(item_category_id %in% !!Categoriesofinterest) %>%
dplyr::group_by(shop_id,item_category_id,date_block_num) %>%
dplyr::summarise(Sale = sum(MonthlyCts,na.rm = T)) %>%
tidyr::spread(item_category_id,Sale)
Agg_Price_Category <- Agg_sales_train %>%
dplyr::ungroup() %>%
dplyr::mutate(shop_id = as.factor(shop_id)) %>%
dplyr::filter(item_category_id %in% !!Categoriesofinterest) %>%
dplyr::group_by(shop_id,item_category_id,date_block_num) %>%
dplyr::summarise(Price = mean(Price,na.rm = T)) %>%
tidyr::spread(item_category_id,Price)
colnames(Agg_Price_Category)[3:(2+length(Categoriesofinterest))] <- paste0("Price",Categoriesofinterest)
Agg_Sales_Category %<>% dplyr::left_join(.,Agg_Price_Category)
# Plotting
Agg_Sales_Category %>% ggplot(mapping = aes(x = `19`, y = `2`,col = shop_id)) + geom_point() + stat_smooth(method = "lm",se = F) + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw() + theme(legend.position = "none") + ggtitle( "PS3 Game sales Vs PS3 Accessories", subtitle = "Colored by shop_id")
fit.PS3Acc <- lm(`2` ~  `19` + `62` +  Price19 + Price2 + Price62 + shop_id, data = Agg_Sales_Category)
summary(fit.PS3Acc)
broom::augment(fit.PS3Acc) %>% lattice::xyplot(.fitted ~ X2, data = .,xlab = "Accesories PS3 sales", ylab = "Fitted PS3 Accesories sale")
Agg_Sales_Category %>% ggplot(mapping = aes(x = `37`, y = `55`,col = shop_id)) + geom_point() + stat_smooth(method = "lm",se = F) + xlab("Cinema Blue Ray") + ylab("Music CD Local") + theme_bw() + theme(legend.position = "none") + ggtitle( "Cinema Blue Ray Vs Music CD local sales", subtitle = "Colored by shop_id")
fit <- lm(`55` ~  `37`  +  Price55 + Price37 + shop_id , data = Agg_Sales_Category)
#summary(fit)
broom::augment(fit) %>% lattice::xyplot(.fitted ~ X55, data = .,xlab = "Cinema Blue Ray Sales", ylab = "Fitted Blue Ray sales")
summary(fit)
fit <- lm(`55` ~  `37`  +  Price55 + Price37 + shop_id , data = Agg_Sales_Category,subset = Agg_Sales_Category$shop_id %in% c(28,31,53,54))
summary(fit)
#summary(fit)
broom::augment(fit) %>% lattice::xyplot(.fitted ~ X55, data = .,xlab = "Cinema Blue Ray Sales", ylab = "Fitted Blue Ray sales")
summary(fit)
fit <- lm(`55` ~  `37`  +  Price55 + Price37 + shop_id , data = Agg_Sales_Category,subset = Agg_Sales_Category$shop_id %in% c(28,31))
#summary(fit)
broom::augment(fit) %>% lattice::xyplot(.fitted ~ X55, data = .,xlab = "Cinema Blue Ray Sales", ylab = "Fitted Blue Ray sales")
summary(fit)
fit <- lm(`55` ~  `37`  +  Price55 + Price37 + shop_id , data = Agg_Sales_Category,subset = Agg_Sales_Category$shop_id %in% c(28,31,53,54))
#summary(fit)
broom::augment(fit) %>% lattice::xyplot(.fitted ~ X55, data = .,xlab = "Cinema Blue Ray Sales", ylab = "Fitted Blue Ray sales")
MusicCDtrain <- Agg_sales_train %>%
dplyr::ungroup() %>%
dplyr::mutate(item__id = as.factor(item_id),shop_id = as.factor(shop_id),Item.Shop = as.factor(Item.Shop)) %>%
dplyr::mutate(item_category_id = as.factor(item_category_id)) %>%
dplyr::filter(item_category_id %in% c(55,37)) %>%
dplyr::select(Item.Shop,MonthlyCts,date_block_num) %>%
tidyr::spread(Item.Shop,MonthlyCts)
items_id_37 <- RetrieveItemStores(category = 37) %>% distinct(item_id)
items_id_55 <- RetrieveItemStores(category = 55) %>% distinct(item_id)
Predictors <- colnames(MusicCDtrain)[stringr::str_detect(colnames(MusicCDtrain), as.character(items_id_37$item_id))]
Reponses <- colnames(MusicCDtrain)[stringr::str_detect(colnames(MusicCDtrain), as.character(items_id_55$item_id))]
MusicCDtrain %>% dplyr::filter(complete.cases(.))
paste0("`",paste0(Predictors,pad = '`'),collapse = "+")
lm(`1201.04` ~ `935.07`+`965`+`2137.35`+`2631.31`+`3620.31`+`4982.29`+`5331.39`+`5331.42`+`6333.18`+`7265.41`+`7314.07`+`7430.26`+`7485.15`+`7499.45`+`7531.07`+`7651.35`+`8280.44`+`8297.34`+`8318.28`+`8683.31`+`8739.46`+`9165.41`+`9578.29`+`9597.31`+`10021.47`+`10300.48`+`10446.45`+`10876.19`+`11629.21`+`12455.31`+`12459.06`+`12718.57`+`12785.13`+`13785.57`+`13855.57`+`14143.24`+`14271.21`+`14282.22`+`14387.42`+`14522.28`+`14672.33`+`15558.43`+`15702.29`+`16677.29`+`16710.44`+`16725.35`+`16874.26`+`16889.52`+`17174.28`+`17499.57`+`17833.13`+`18259.46`+`18537.13`+`18589.5`+`18592.57`+`18881.38`+`19162.48`+`19185.54`+`19195.35`+`19287.07`+`19547.51`+`21357.49`+`21426.42`+`21542.15`+`21647.5`,data = MusicCDtrain,singular.ok = T)
corrplot::corrplot(cormat2,method = c("number"))
HighCors2 <- subset(melt(cormat2,varnames = c('CatA', 'CatB'), value.name = 'Correlations'), Correlations >= 0.8 & Correlations < 1)
corrplot::corrplot(cormat2,method = c("number"))
HighCors2
Agg_Sales_Category
Agg_sales_train
MonthlySalebyCategoryGrp
MonthlySales.ItemShop
str(MonthlySales.ItemShop)
ArrangeData <- function(data = MonthlySales.ItemShop, Category = NULL, ...){
print(...)
}
ArrangeData("achaku")
ArrangeData("achaku")
list(...)
print(list(...))
ArrangeData <- function(data = MonthlySales.ItemShop, Category = NULL, ...){
print(list(...))
}
ArrangeData("achaku")
ArrangeData <- function(data = MonthlySales.ItemShop, Category = NULL, ...){
opts <- list(...)
}
ArrangeData("achaku")
ArrangeData <- function(data = MonthlySales.ItemShop, Category = NULL, ...){
opts <- list(...)
opts
}
ArrangeData("achaku")
ArrangeData(dus = "achaku")
ArrangeData(dus = 1)
unlist(ArrangeData(dus = 1))
unlist(ArrangeData(dus = 1,bus = 2))
MonthlySales.ItemShop
#--------------------------------------------------------------------------------------------------
#                               Aggregated data
#--------------------------------------------------------------------------------------------------
Agg_sales_train <- sales_train %>%
dplyr::mutate(date = lubridate::parse_date_time(date,orders = "%d.%m.%Y"),
month = lubridate::month(date)) %>%
dplyr::group_by(item_id,shop_id,date_block_num,month) %>%
dplyr::summarise(MonthlyCts = sum(item_cnt_day),Price = mean(item_price,na.rm = T)) %>%
dplyr::arrange(item_id,shop_id,date_block_num) %>%
dplyr::mutate(Item.Shop = item_id + shop_id / 100) %>%
dplyr::left_join(x = ., y = Items[,2:3]) %>%
dplyr::left_join(x =., y = ItemsReference[,c(1,5:12)]) %>%
dplyr::left_join(x =., y = ShopReference[,2:5])
str(Agg_sales_train)
#---------------------------------------------------------------------------------------
# Monthly sales reference data frame includes shop id
#---------------------------------------------------------------------------------------
MonthlySales.ItemShop <- df %>%
dplyr::left_join(.,Agg_sales_train[1:6]) %>%
dplyr::left_join(.,ItemsReference[-2]) %>%
dplyr::left_join(.,ShopReference[2:3]) %>%
dplyr::mutate(city = as.factor(city))
str(MonthlySales.ItemShop)
Agg_sales_train %>% dplyr::distinct(date_block_num,month)
Agg_sales_train %>% dplyr::ungroup() %>%  dplyr::distinct(date_block_num,month)
#--------------------------------------------------------------------------------------------------
#                               Aggregated data
#--------------------------------------------------------------------------------------------------
Agg_sales_train <- sales_train %>%
dplyr::mutate(date = lubridate::parse_date_time(date,orders = "%d.%m.%Y"),
month = lubridate::month(date),
year = lubridate::year(date)) %>%
dplyr::group_by(item_id,shop_id,date_block_num,month) %>%
dplyr::summarise(MonthlyCts = sum(item_cnt_day),Price = mean(item_price,na.rm = T)) %>%
dplyr::arrange(item_id,shop_id,date_block_num) %>%
dplyr::mutate(Item.Shop = item_id + shop_id / 100) %>%
dplyr::left_join(x = ., y = Items[,2:3]) %>%
dplyr::left_join(x =., y = ItemsReference[,c(1,5:12)]) %>%
dplyr::left_join(x =., y = ShopReference[,2:5])
n_distinct(Agg_sales_train$Item.Shop)
#--------------------------------------------------------------------------------------------------
#                               Aggregated data
#--------------------------------------------------------------------------------------------------
Agg_sales_train <- sales_train %>%
dplyr::mutate(date = lubridate::parse_date_time(date,orders = "%d.%m.%Y"),
month = lubridate::month(date),
year = lubridate::year(date),
YearMonth = year + month/100) %>%
dplyr::group_by(item_id,shop_id,date_block_num,month) %>%
dplyr::summarise(MonthlyCts = sum(item_cnt_day),Price = mean(item_price,na.rm = T)) %>%
dplyr::arrange(item_id,shop_id,date_block_num) %>%
dplyr::mutate(Item.Shop = item_id + shop_id / 100) %>%
dplyr::left_join(x = ., y = Items[,2:3]) %>%
dplyr::left_join(x =., y = ItemsReference[,c(1,5:12)]) %>%
dplyr::left_join(x =., y = ShopReference[,2:5])
str(Agg_sales_train)
#--------------------------------------------------------------------------------------------------
#                               Aggregated data
#--------------------------------------------------------------------------------------------------
Agg_sales_train <- sales_train %>%
dplyr::mutate(date = lubridate::parse_date_time(date,orders = "%d.%m.%Y"),
month = lubridate::month(date),
year = lubridate::year(date),
YearMonth = (year + month/100)) %>%
dplyr::group_by(item_id,shop_id,date_block_num,month) %>%
dplyr::summarise(MonthlyCts = sum(item_cnt_day),Price = mean(item_price,na.rm = T)) %>%
dplyr::arrange(item_id,shop_id,date_block_num) %>%
dplyr::mutate(Item.Shop = item_id + shop_id / 100) %>%
dplyr::left_join(x = ., y = Items[,2:3]) %>%
dplyr::left_join(x =., y = ItemsReference[,c(1,5:12)]) %>%
dplyr::left_join(x =., y = ShopReference[,2:5])
str(Agg_sales_train)
#--------------------------------------------------------------------------------------------------
#                               Aggregated data
#--------------------------------------------------------------------------------------------------
Agg_sales_train <- sales_train %>%
dplyr::mutate(date = lubridate::parse_date_time(date,orders = "%d.%m.%Y"),
month = lubridate::month(date),
year = lubridate::year(date),
YearMonth = (year + month/100)) %>%
dplyr::group_by(item_id,shop_id,date_block_num,YearMonth) %>%
dplyr::summarise(MonthlyCts = sum(item_cnt_day),Price = mean(item_price,na.rm = T)) %>%
dplyr::arrange(item_id,shop_id,date_block_num) %>%
dplyr::mutate(Item.Shop = item_id + shop_id / 100) %>%
dplyr::left_join(x = ., y = Items[,2:3]) %>%
dplyr::left_join(x =., y = ItemsReference[,c(1,5:12)]) %>%
dplyr::left_join(x =., y = ShopReference[,2:5])
str(Agg_sales_train)
Agg_sales_train %>% dplyr::ungroup() %>% dplyr::distinct(date_block_num,YearMonth)
View(.Last.value)
Agg_sales_train %>% dplyr::ungroup() %>% dplyr::distinct(date_block_num,YearMonth) %>% arrange(date_block_num)
View(.Last.value)
str(df)
dateblockref <- Agg_sales_train %>% dplyr::ungroup() %>% dplyr::distinct(date_block_num,YearMonth) %>% arrange(date_block_num)
dateblockref
rep(dateblockref,2)
data.frame(rep(dateblockref,2))
dateblockref <-
Agg_sales_train %>% dplyr::ungroup() %>%
dplyr::distinct(date_block_num, YearMonth) %>%
arrange(date_block_num) %>% tidyr::separate(YearMonth,c("year","month"))
head(dateblockref)
dateblockref <-
Agg_sales_train %>% dplyr::ungroup() %>%
dplyr::distinct(date_block_num, YearMonth) %>%
arrange(date_block_num) %>%
tidyr::separate(YearMonth,c("year","month")) %>%
dplyr::mutate_at(.vars = c("year","month"),funs(factor))
head(dateblockref)
dateblockref <-
Agg_sales_train %>% dplyr::ungroup() %>%
dplyr::distinct(date_block_num, YearMonth) %>%
arrange(date_block_num) %>%
tidyr::separate(YearMonth,c("year","month")) %>%
dplyr::mutate_at(.vars = c("year","month"),funs(numeric))
dateblockref <-
Agg_sales_train %>% dplyr::ungroup() %>%
dplyr::distinct(date_block_num, YearMonth) %>%
arrange(date_block_num) %>%
tidyr::separate(YearMonth,c("year","month")) %>%
dplyr::mutate_at(.vars = c("year","month"),funs(as.numeric))
head(dateblockref)
df <-
data.frame(
date_block_num = rep(seq(
min(Agg_sales_train$date_block_num),
max(Agg_sales_train$date_block_num)
), n_distinct(Agg_sales_train$Item.Shop)),
Item.Shop = rep(
unique(Agg_sales_train$Item.Shop),
each = max(Agg_sales_train$date_block_num) - min(Agg_sales_train$date_block_num) + 1
)
) %>%
tidyr::separate(., 2, c("item_id", "shop_id")) %>%
dplyr::mutate(shop_id = ifelse(is.na(shop_id), 0, shop_id)) %>%
dplyr::mutate(item_id = as.numeric(item_id), shop_id = as.numeric(shop_id)) %>%
dplyr::left_join(.,dateblockref)
head(df)
#---------------------------------------------------------------------------------------
# Monthly sales reference data frame includes shop id
#---------------------------------------------------------------------------------------
MonthlySales.ItemShop <- df %>%
dplyr::left_join(.,Agg_sales_train[1:7]) %>%
dplyr::left_join(.,ItemsReference[-2]) %>%
dplyr::left_join(.,ShopReference[2:3]) %>%
dplyr::mutate(city = as.factor(city))
head(MonthlySales.ItemShop)
#---------------------------------------------------------------------------------------
# Monthly sales reference data frame includes shop id
#---------------------------------------------------------------------------------------
MonthlySales.ItemShop <- df %>%
dplyr::left_join(.,Agg_sales_train[1:7]) %>%
dplyr::left_join(.,ItemsReference[-2]) %>%
dplyr::left_join(.,ShopReference[2:3]) %>%
dplyr::mutate(city = as.factor(city)) %>%
dplyr::select(-YearMonth) # redundant
#---------------------------------------------------------------------------------------
# Monthly sales reference data frame includes shop id
#---------------------------------------------------------------------------------------
MonthlySales.ItemShop <- df %>%
dplyr::left_join(.,Agg_sales_train[1:7]) %>%
dplyr::left_join(.,ItemsReference[-2]) %>%
dplyr::left_join(.,ShopReference[2:3]) %>%
dplyr::mutate(city = as.factor(city)) %>%
dplyr::select(-YearMonth,-Item.Shop) %>% # redundant
dplyr::mutate(imp = ifelse(is.na(MonthlyCts),1,0)) %>% # id rows imputed
dplyr::mutate(MonthlyCts = ifelse(imp==1,0,MonthlyCts),# impute NAs with zero - no sale; leaving price as is for now
Item.Shop = item_id+shop_id/100) %>%
dplyr::arrange(Item.Shop,date_block_num) %>%
dplyr::mutate(Cusum = ave(x = MonthlyCts,Item.Shop, FUN = cumsum))
head(MonthlySales.ItemShop)
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`Games-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `Games-PS3`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`GameConsoles-PS3`,`Accessories-PS3`) %>% ggplot(mapping = aes(x = `GameConsoles-PS3`, y = `Accessories-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("Accesories PS3") + theme_bw()
MonthlySalebyCategory %>%
dplyr::ungroup() %>%
dplyr::select(`GameConsoles-PS3`,`GameConsoles-PSVita`) %>% ggplot(mapping = aes(x = `GameConsoles-PSVita`, y = `GameConsoles-PS3`)) + geom_point() + stat_smooth(method = "lm") + xlab("Games Consoles PS3") + ylab("PS Vita") + theme_bw()
# Data set up
Categoriesofinterest <- c(2,5,11,19,32,37:40,55:60,62)
Agg_Sales_Category <- Agg_sales_train %>% dplyr::ungroup() %>%
dplyr::mutate(shop_id = as.factor(shop_id)) %>%
dplyr::filter(item_category_id %in% !!Categoriesofinterest) %>%
dplyr::group_by(shop_id,item_category_id,date_block_num) %>%
dplyr::summarise(Sale = sum(MonthlyCts,na.rm = T)) %>%
tidyr::spread(item_category_id,Sale)
Agg_Price_Category <- Agg_sales_train %>%
dplyr::ungroup() %>%
dplyr::mutate(shop_id = as.factor(shop_id)) %>%
dplyr::filter(item_category_id %in% !!Categoriesofinterest) %>%
dplyr::group_by(shop_id,item_category_id,date_block_num) %>%
dplyr::summarise(Price = mean(Price,na.rm = T)) %>%
tidyr::spread(item_category_id,Price)
colnames(Agg_Price_Category)[3:(2+length(Categoriesofinterest))] <- paste0("Price",Categoriesofinterest)
Agg_Sales_Category %<>% dplyr::left_join(.,Agg_Price_Category)
# Plotting
Agg_Sales_Category %>% ggplot(mapping = aes(x = `19`, y = `2`,col = shop_id)) + geom_point() + stat_smooth(method = "lm",se = F) + xlab("Games PS3") + ylab("Accesories PS3") + theme_bw() + theme(legend.position = "none") + ggtitle( "PS3 Game sales Vs PS3 Accessories", subtitle = "Colored by shop_id")
str(Agg_Sales_Category)
# Correlation plot
corrplot::corrplot(cormat,order = "hclust",tl.cex = 0.3)
library(reshape2)
HighCors <- subset(melt(cormat,varnames = c('CatA', 'CatB'), value.name = 'Correlations'), Correlations >= 0.8 & Correlations < 1)
HighCors[which(HighCors$CatA == 40),] %>% distinct(CatB)
testdf <- RetrieveItemStores(category = 2) %>% distinct(item_id)
# Roll up category further
MonthlySalebyCategoryGrp <-
MonthlySales.ItemShop %>% dplyr::group_by(date_block_num, item_category_id) %>%
dplyr::summarise(SaleCounts = sum(MonthlyCts, na.rm = T)) %>%
dplyr::left_join(.,ItemCatNomenclature) %>%
dplyr::ungroup() %>%
dplyr::mutate(SuperCategory = unlist(purrr::map(item_category_name_translated, SuperCategory)))
MonthlySalebyCategoryGrp %<>%
dplyr::group_by(date_block_num,SuperCategory) %>%
dplyr::summarise(Sales = sum(SaleCounts)) %>%
tidyr::spread(SuperCategory,Sales)
cormat2 <- cor(MonthlySalebyCategoryGrp[-1])
corrplot::corrplot(cormat2,method = c("number"))
HighCors2 <- subset(melt(cormat2,varnames = c('CatA', 'CatB'), value.name = 'Correlations'), Correlations >= 0.8 & Correlations < 1)
str(MonthlySales.ItemShop)
fpp::usconsumption
lmdata <- MonthlySales.ItemShop %>%
dplyr::select(-date_block_num,-Item.Shop) %>%
dplyr::mutate_at(.vars = c(1,2,7,8), funs(factor))
head(lmdata)
plot(lmdata$Cusum)
install.packages("lattice")
install.packages("lattice")
library(lattice)
library(lattice)
install.packages("lattice")
install.packages("lattice")
